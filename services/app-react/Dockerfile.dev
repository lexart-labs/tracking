FROM node:24-alpine AS builder-base
WORKDIR /app
COPY package*.json ./
RUN npm ci

# ---- Fase 2: Constructor (Builder) ----
FROM builder-base AS builder
WORKDIR /app
COPY . .
RUN npm run build

# ---- Fase 3: Producción Final (Runner) ----
FROM node:24-alpine AS runner
WORKDIR /app

# ¡CORRECCIÓN AQUÍ! Copiamos ambos archivos: package.json Y package-lock.json
COPY --from=builder /app/package*.json ./

# Usamos la sintaxis moderna y solo instalamos dependencias de producción (como 'serve')
RUN npm ci --omit=dev

# Copiamos los archivos estáticos ya construidos desde la etapa 'builder'
COPY --from=builder /app/dist ./dist

# Creamos y usamos un usuario no-root por seguridad
RUN addgroup -S appgroup && adduser -S appuser -G appgroup
USER appuser

# Asegúrate de tener el script "start" en tu package.json: "serve -s dist -l 3000"
CMD [ "npm", "start" ]